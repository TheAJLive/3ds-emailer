<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Discord Bot Client (3DS-safe)</title>
<style>
  body { font-family: Arial, sans-serif; margin: 10px; }
  label { display:block; margin-top:8px; }
  input[type=text], textarea, select { width: 100%; box-sizing: border-box; }
  button { margin-top:8px; }
  #row { margin: 8px 0; }
  #messages { border:1px solid #ccc; height:380px; overflow-y:scroll; padding:6px; }
  .msg { border-bottom:1px solid #eee; padding:6px 0; }
  .head { display:flex; align-items:center; }
  .pfp { width:28px; height:28px; border-radius:50%; margin-right:6px; }
  .name { font-weight:bold; }
  .time { color:#666; font-size:12px; margin-left:6px; }
  .content { margin-top:2px; white-space:pre-wrap; }
  .hint { color:#a00; font-size:12px; }
</style>
</head>
<body>

<!-- ==== CONFIG (edit these two values) ==== -->
<script>
  // Worker URL of your deployed Cloudflare Worker:
  var WORKER_URL_DEFAULT = "https://discord-proxy.x528vbxtdp.workers.dev/"; // e.g., https://discord-proxy.username.workers.dev
  // Simple page password (must match SHARED_KEY in the Worker):
  var PAGE_PASSWORD = "3DS";
</script>
<!-- ======================================= -->

<script>
(function(){
  // Simple password gate (client-side). Worker also checks same key.
  var pass = prompt("Enter password:");
  if(pass !== PAGE_PASSWORD){
    document.write("Access denied.");
    throw new Error("wrong password");
  }
})();
</script>

<h2>Discord Bot Client</h2>

<label>Worker URL
  <input id="worker" type="text" placeholder="https://your-worker.workers.dev">
</label>

<label>Server (Guild)
  <select id="guild"></select>
</label>

<label>Channel
  <select id="channel"></select>
</label>
<small class="hint">Bot must be in the server with View Channel + Read Message History + Send Messages.</small>

<label>Message
  <textarea id="content" rows="4" placeholder="Type..."></textarea>
</label>

<label>Image (single)
  <input id="file" type="file" accept="image/*">
</label>

<button id="sendBtn">Send</button>
<button id="refreshBtn">Refresh</button>

<h3>Messages</h3>
<div id="messages"></div>

<script>
(function(){
  var $ = function(id){ return document.getElementById(id); };
  var worker = $('worker'), guildSel = $('guild'), channelSel = $('channel');
  var content = $('content'), file = $('file');
  var sendBtn = $('sendBtn'), refreshBtn = $('refreshBtn');
  var messages = $('messages');

  // Prefill worker URL
  worker.value = WORKER_URL_DEFAULT || "";

  function esc(s){
    return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }
  function isoToLocal(ts){
    try{
      var d = new Date(ts);
      var y=d.getFullYear(), m=('0'+(d.getMonth()+1)).slice(-2), day=('0'+d.getDate()).slice(-2);
      var hh=('0'+d.getHours()).slice(-2), mm=('0'+d.getMinutes()).slice(-2);
      return y+'-'+m+'-'+day+' '+hh+':'+mm;
    }catch(e){ return ts||''; }
  }
  function xhrGET(url, cb){
    var x = new XMLHttpRequest();
    x.open('GET', url, true);
    x.setRequestHeader('X-Key', PAGE_PASSWORD); // worker-side auth
    x.onreadystatechange=function(){
      if(x.readyState===4){ cb(x.status, x.responseText); }
    };
    x.send();
  }
  function xhrPOST(url, form, cb){
    var x = new XMLHttpRequest();
    x.open('POST', url, true);
    x.setRequestHeader('X-Key', PAGE_PASSWORD); // worker-side auth
    x.onreadystatechange=function(){
      if(x.readyState===4){ cb(x.status, x.responseText); }
    };
    x.send(form);
  }

  function render(list){
    messages.innerHTML = '';
    for (var i=0;i<list.length;i++){
      var m = list[i];
      var div = document.createElement('div'); div.className='msg';

      var head = document.createElement('div'); head.className='head';
      var img = document.createElement('img'); img.className='pfp'; img.src = m.avatar_url || '';
      head.appendChild(img);

      var name = document.createElement('span'); name.className='name';
      var shown = m.display_name || m.username || 'user';
      name.textContent = shown;
      if (m.role_color) name.style.color = m.role_color;
      head.appendChild(name);

      var time = document.createElement('span'); time.className='time';
      time.textContent = 'Â· ' + isoToLocal(m.timestamp);
      head.appendChild(time);

      var body = document.createElement('div'); body.className='content';
      body.innerHTML = esc(m.content||'');

      div.appendChild(head);
      div.appendChild(body);

      if (m.attachments && m.attachments.length){
        for (var j=0;j<m.attachments.length;j++){
          var a=m.attachments[j];
          if (a.url && /\.(png|jpg|jpeg|gif|webp)$/i.test(a.url)){
            var im = document.createElement('img');
            im.src = a.url; im.alt='attachment';
            im.style.maxWidth='100%'; im.style.display='block'; im.style.marginTop='4px';
            div.appendChild(im);
          }
        }
      }
      messages.appendChild(div);
    }
  }

  function loadGuilds(){
    var w = worker.value.trim();
    if(!w){ alert('Set Worker URL'); return; }
    xhrGET(w+'?mode=guilds', function(st, txt){
      if(st>=200 && st<300){
        var arr=[]; try{ arr = JSON.parse(txt)||[]; }catch(e){}
        guildSel.innerHTML='';
        for (var i=0;i<arr.length;i++){
          var opt = document.createElement('option');
          opt.value = arr[i].id;
          opt.text = arr[i].name;
          guildSel.appendChild(opt);
        }
        loadChannels(); // auto-load channels for first guild
      } else {
        alert('Failed to load servers');
      }
    });
  }

  function loadChannels(){
    var w = worker.value.trim();
    var gid = guildSel.value;
    if(!w||!gid){ return; }
    xhrGET(w+'?mode=channels&guild_id='+encodeURIComponent(gid), function(st, txt){
      if(st>=200 && st<300){
        var arr=[]; try{ arr = JSON.parse(txt)||[]; }catch(e){}
        channelSel.innerHTML='';
        for (var i=0;i<arr.length;i++){
          var opt = document.createElement('option');
          opt.value = arr[i].id;
          opt.text = arr[i].name;
          channelSel.appendChild(opt);
        }
        refresh(); // auto-refresh first channel
      } else {
        alert('Failed to load channels');
      }
    });
  }

  function refresh(){
    var w = worker.value.trim(), ch = channelSel.value;
    if(!w||!ch){ return; }
    xhrGET(w+'?mode=history&channel_id='+encodeURIComponent(ch), function(st, txt){
      if(st>=200&&st<300){
        var data=[]; try{ data = JSON.parse(txt)||[]; }catch(e){}
        render(data);
      }
    });
  }

  function send(){
    var w = worker.value.trim(), ch = channelSel.value;
    if(!w||!ch){ alert('Choose server and channel'); return; }

    var form = new FormData();
    form.append('mode','send');
    form.append('channel_id', ch);
    form.append('content', content.value||'');
    if (file.files && file.files[0]) form.append('file', file.files[0], file.files[0].name||'image');

    xhrPOST(w, form, function(st){
      // reset so you can send more without page refresh
      file.value = '';
      content.value = '';
      refresh();
    });
  }

  guildSel.onchange = loadChannels;
  channelSel.onchange = refresh;
  sendBtn.onclick = send;
  refreshBtn.onclick = refresh;

  // kick off
  loadGuilds();
})();
</script>
</body>
</html>
