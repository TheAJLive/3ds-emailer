<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Discord Bot Client (3DS-safe)</title>
<style>
  body { font-family: Arial, sans-serif; margin: 10px; }
  label { display:block; margin-top:8px; }
  input[type=text], textarea { width: 100%; box-sizing: border-box; }
  button { margin-top:8px; }
  #messages { border:1px solid #ccc; height:380px; overflow-y:scroll; padding:6px; }
  .msg { border-bottom:1px solid #eee; padding:6px 0; }
  .head { display:flex; align-items:center; }
  .pfp { width:28px; height:28px; border-radius:50%; margin-right:6px; }
  .name { font-weight:bold; }
  .time { color:#666; font-size:12px; }
  .content { margin-top:2px; white-space:pre-wrap; }
  .hint { color:#a00; font-size:12px; }
</style>
</head>
<body>
<h2>Discord Bot Client</h2>

<label>Worker URL
  <input id="worker" type="text" placeholder="https://your-worker.workers.dev">
</label>

<label>Channel ID
  <input id="channel" type="text" placeholder="123456789012345678">
</label>
<small class="hint">Bot must be in the server, with View Channel + Read Message History + Send Messages.</small>

<label>Message
  <textarea id="content" rows="4" placeholder="Type..."></textarea>
</label>

<label>Image (single)
  <input id="file" type="file" accept="image/*">
</label>

<button id="sendBtn">Send</button>
<button id="refreshBtn">Refresh</button>

<h3>Messages</h3>
<div id="messages"></div>

<script>
(function(){
  var $ = function(id){ return document.getElementById(id); };
  var worker = $('worker'), channel = $('channel');
  var content = $('content'), file = $('file');
  var sendBtn = $('sendBtn'), refreshBtn = $('refreshBtn');
  var messages = $('messages');

  function esc(s){
    return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  function isoToLocal(ts){
    try{
      var d = new Date(ts);
      var y=d.getFullYear(), m=('0'+(d.getMonth()+1)).slice(-2), day=('0'+d.getDate()).slice(-2);
      var hh=('0'+d.getHours()).slice(-2), mm=('0'+d.getMinutes()).slice(-2);
      return y+'-'+m+'-'+day+' '+hh+':'+mm;
    }catch(e){ return ts||''; }
  }

  function render(list){
    messages.innerHTML = '';
    for (var i=0;i<list.length;i++){
      var m = list[i];
      var div = document.createElement('div'); div.className='msg';

      var head = document.createElement('div'); head.className='head';
      var img = document.createElement('img'); img.className='pfp'; img.src = m.avatar_url || '';
      head.appendChild(img);

      var name = document.createElement('span'); name.className='name';
      var shown = m.display_name || m.username || 'user';
      name.textContent = shown + ' ';
      head.appendChild(name);

      if (m.role_color){ name.style.color = m.role_color; }

      var time = document.createElement('span'); time.className='time';
      time.textContent = 'Â· ' + isoToLocal(m.timestamp);
      head.appendChild(time);

      var body = document.createElement('div'); body.className='content';
      body.innerHTML = esc(m.content||'');

      div.appendChild(head);
      div.appendChild(body);

      if (m.attachments && m.attachments.length){
        for (var j=0;j<m.attachments.length;j++){
          var a=m.attachments[j];
          if (a.url && /\.(png|jpg|jpeg|gif|webp)$/i.test(a.url)){
            var im = document.createElement('img');
            im.src = a.url; im.alt='attachment';
            im.style.maxWidth='100%'; im.style.display='block'; im.style.marginTop='4px';
            div.appendChild(im);
          }
        }
      }
      messages.appendChild(div);
    }
  }

  function refresh(){
    var w = worker.value.trim(), ch = channel.value.trim();
    if(!w||!ch){ alert('Set Worker URL and Channel ID'); return; }
    var xhr = new XMLHttpRequest();
    xhr.open('GET', w+'?mode=history&channel_id='+encodeURIComponent(ch), true);
    xhr.onreadystatechange=function(){
      if(xhr.readyState===4){
        if(xhr.status>=200&&xhr.status<300){
          try{ render(JSON.parse(xhr.responseText)||[]); }catch(e){}
        }
      }
    };
    xhr.send();
  }

  function send(){
    var w = worker.value.trim(), ch = channel.value.trim();
    if(!w||!ch){ alert('Set Worker URL and Channel ID'); return; }

    var form = new FormData();
    form.append('mode','send');
    form.append('channel_id', ch);
    form.append('content', content.value||'');
    if (file.files && file.files[0]) form.append('file', file.files[0], file.files[0].name||'image');

    var xhr = new XMLHttpRequest();
    xhr.open('POST', w, true);
    xhr.onreadystatechange=function(){
      if(xhr.readyState===4){
        // reset input so you can upload/send again without refresh
        file.value = '';
        content.value = '';
        refresh();
      }
    };
    xhr.send(form);
  }

  sendBtn.onclick = send;
  refreshBtn.onclick = refresh;

  // Auto-refresh once if worker/channel prefilled
  setTimeout(refresh, 300);
})();
</script>
</body>
</html>
